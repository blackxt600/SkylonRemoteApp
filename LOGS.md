# Log Management for SkylonRemoteApp

This guide explains how to manage logs generated by the SkylonRemoteApp service on Raspberry Pi.

## ðŸ“‹ Table of Contents

- [Quick Setup (Automated)](#quick-setup-automated)
- [Why Log Management Matters](#why-log-management-matters)
- [What Logs Are Generated](#what-logs-are-generated)
- [Viewing Logs](#viewing-logs)
- [Manual Configuration](#manual-configuration)
- [Monitoring Disk Usage](#monitoring-disk-usage)
- [Troubleshooting](#troubleshooting)

## ðŸš€ Quick Setup (Automated)

**Recommended method:** Use the automated setup script to configure log management.

```bash
cd ~/Documents/SkylonRemoteApp/autostart
./setup-log-management.sh
```

The script will:
- âœ… Install journald size limits (50 MB max)
- âœ… Clean existing logs
- âœ… Restart systemd-journald
- âœ… Optionally set up weekly automatic cleanup (cron)
- âœ… Display current disk usage

If you prefer manual configuration, see [Manual Configuration](#manual-configuration) below.

## âš ï¸ Why Log Management Matters

### The Problem

The SkylonRemoteApp generates frequent logs:
- **Bluetooth connection attempts** every 30 seconds (when disconnected)
- **Device status updates** every second (when connected)
- **Training program events** (start, stop, interval changes)
- **HTTP requests** from the web interface
- **Power level changes**

**Without log management, journald can consume 200-300 MB** on a Raspberry Pi with limited disk space (8-32 GB SD cards).

### The Solution

Implement automatic log rotation and size limits to keep logs under 50 MB while maintaining recent history for debugging.

## ðŸ“ What Logs Are Generated

### Normal Operation Logs

```
Dec 12 10:15:23 raspberrypi cargo[1234]: Attempting to reconnect to Bluetooth device...
Dec 12 10:15:26 raspberrypi cargo[1234]: Connected to device: SKYLON
Dec 12 10:15:27 raspberrypi cargo[1234]: Status: RPM=65, Speed=11.2 km/h, Power=100W
Dec 12 10:15:28 raspberrypi cargo[1234]: Status: RPM=66, Speed=11.4 km/h, Power=100W
```

### Error Logs

```
Dec 12 10:20:15 raspberrypi cargo[1234]: Error: Bluetooth device disconnected
Dec 12 10:20:18 raspberrypi cargo[1234]: Reconnection attempt 1/5 failed
```

### Log Volume Example

- **Per second**: ~100 bytes (status update)
- **Per minute**: ~6 KB
- **Per hour**: ~360 KB
- **Per day**: ~8.5 MB
- **Per week**: ~60 MB
- **Per month**: ~250 MB âš ï¸

## ðŸ‘€ Viewing Logs

### Real-time Logs (tail -f)

```bash
sudo journalctl -u skylon-remote.service -f
```

Press `Ctrl+C` to stop.

### Recent Logs

```bash
# Last 50 lines
sudo journalctl -u skylon-remote.service -n 50

# Last 200 lines
sudo journalctl -u skylon-remote.service -n 200

# All logs since last boot
sudo journalctl -u skylon-remote.service -b
```

### Logs by Date/Time

```bash
# Since specific date
sudo journalctl -u skylon-remote.service --since "2025-12-12"

# Since specific time
sudo journalctl -u skylon-remote.service --since "2025-12-12 10:00:00"

# Last 2 hours
sudo journalctl -u skylon-remote.service --since "2 hours ago"

# Last 30 minutes
sudo journalctl -u skylon-remote.service --since "30 min ago"

# Between two times
sudo journalctl -u skylon-remote.service --since "2025-12-12 10:00" --until "2025-12-12 12:00"
```

### Filtering Logs

```bash
# Only errors and warnings
sudo journalctl -u skylon-remote.service -p err

# Only errors
sudo journalctl -u skylon-remote.service -p 3

# Grep for specific text
sudo journalctl -u skylon-remote.service | grep "Bluetooth"
sudo journalctl -u skylon-remote.service | grep "Error"
```

## âš™ï¸ Manual Configuration

### Step 1: Install Journald Limits

Create journald configuration to limit log size:

```bash
# Create configuration directory
sudo mkdir -p /etc/systemd/journald.conf.d/

# Copy configuration file
sudo cp ~/Documents/SkylonRemoteApp/autostart/journald-limit.conf \
       /etc/systemd/journald.conf.d/skylon.conf

# Restart journald to apply changes
sudo systemctl restart systemd-journald
```

The configuration (`journald-limit.conf`) contains:
```ini
[Journal]
SystemMaxUse=50M          # Maximum 50 MB total
RuntimeMaxUse=20M         # Maximum 20 MB in RAM
SystemMaxFileSize=10M     # Rotate after 10 MB
MaxRetentionSec=1week     # Keep 1 week maximum
MaxFileSec=1day           # Rotate daily
```

### Step 2: Clean Existing Logs

```bash
# Clean logs older than 3 days
sudo journalctl --vacuum-time=3d

# Clean logs to maximum 50 MB
sudo journalctl --vacuum-size=50M
```

### Step 3: Set Up Weekly Cleanup (Optional)

Configure automatic weekly cleanup:

```bash
# Make cleanup script executable
chmod +x ~/Documents/SkylonRemoteApp/autostart/cleanup-logs.sh

# Edit crontab
crontab -e

# Add this line (runs every Sunday at 2 AM):
0 2 * * 0 /home/skylon/Documents/SkylonRemoteApp/autostart/cleanup-logs.sh >> /home/skylon/log-cleanup.log 2>&1
```

**Important:** Replace `skylon` with your username.

## ðŸ“Š Monitoring Disk Usage

### Check Current Log Size

```bash
# Show disk usage by journald
journalctl --disk-usage
```

Example output:
```
Archived and active journals take up 48.2M in the file system.
```

### Check Available Disk Space

```bash
# Show disk usage
df -h

# Show disk usage of /var/log
du -sh /var/log/journal/
```

### Verify Limits Are Applied

```bash
# Show journald configuration
sudo journalctl --verify

# Check configuration
systemctl status systemd-journald
```

## ðŸ”§ Troubleshooting

### Logs Still Growing Too Large

**Check if limits are applied:**
```bash
journalctl --disk-usage
```

If logs exceed 50 MB:

1. **Verify configuration is installed:**
   ```bash
   ls -la /etc/systemd/journald.conf.d/skylon.conf
   cat /etc/systemd/journald.conf.d/skylon.conf
   ```

2. **Restart journald:**
   ```bash
   sudo systemctl restart systemd-journald
   ```

3. **Force cleanup:**
   ```bash
   sudo journalctl --vacuum-size=50M
   sudo journalctl --rotate
   ```

### Can't View Logs

**Error:** "No journal files were found"

**Solution:**
```bash
# Check service status
sudo systemctl status skylon-remote.service

# Check if service exists
sudo systemctl list-units | grep skylon
```

### Logs Disappear After Reboot

**Cause:** Journald not configured for persistent storage

**Solution:**
```bash
# Enable persistent storage
sudo mkdir -p /var/log/journal
sudo systemctl restart systemd-journald
```

### Want to Completely Disable Logs

**Not recommended** (makes debugging impossible), but possible:

Edit the service file:
```bash
sudo nano /etc/systemd/system/skylon-remote.service
```

Uncomment these lines:
```ini
StandardOutput=null
StandardError=null
```

Reload and restart:
```bash
sudo systemctl daemon-reload
sudo systemctl restart skylon-remote.service
```

## ðŸ“ˆ Log Retention Recommendations

| Disk Space Available | Recommended MaxUse | Retention Period |
|---------------------|-------------------|------------------|
| < 8 GB              | 20M               | 3 days           |
| 8-16 GB             | 50M               | 1 week           |
| 16-32 GB            | 100M              | 2 weeks          |
| > 32 GB             | 200M              | 1 month          |

## ðŸ”— Related Files

- `autostart/journald-limit.conf` - Journald size limit configuration
- `autostart/cleanup-logs.sh` - Manual cleanup script
- `autostart/setup-log-management.sh` - Automated setup script
- `autostart/skylon-remote.service` - Service file with log configuration

## ðŸ“š Additional Resources

- [systemd-journald documentation](https://www.freedesktop.org/software/systemd/man/systemd-journald.service.html)
- [journalctl documentation](https://www.freedesktop.org/software/systemd/man/journalctl.html)
- [Raspberry Pi disk management](https://www.raspberrypi.org/documentation/linux/filesystem/)

---

**Summary:** Keep logs under control with automated limits and rotation to prevent disk space issues on Raspberry Pi.
