<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contr√¥le V√©lo Elliptique</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f0f1e;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            position: relative;
            overflow-x: hidden;
            color: white;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
            animation: gradient-shift 20s ease infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes gradient-shift {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(-5%, -5%);
            }
        }

        .container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
            padding: 20px;
            width: 100%;
            max-width: 1600px;
            height: 95vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            height: 100%;
            overflow-y: auto;
        }

        .left-column,
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        /* Panels */
        .panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        /* Timer Panel - Enhanced */
        .timer-panel {
            background: linear-gradient(145deg, rgba(139, 92, 246, 0.15), rgba(167, 139, 250, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.15);
            flex: 0 0 auto;
        }

        .timer-display {
            font-size: 5em;
            font-weight: 800;
            font-family: 'Inter', monospace;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
            line-height: 1;
        }

        .timer-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .timer-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            color: #7c3aed;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .timer-btn:active {
            transform: scale(0.95);
        }

        .timer-btn.running {
            background: #ef4444;
            color: white;
            box-shadow: 0 5px 20px rgba(239, 68, 68, 0.4);
        }

        /* RPM Chart Panel */
        .rpm-chart-panel {
            flex: 1;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
        }

        .rpm-chart-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
        }

        .rpm-chart-container {
            flex: 1;
            width: 100%;
            min-height: 200px;
            position: relative;
        }

        /* Program Panel */
        .program-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 24px;
            padding: 25px;
            display: flex;
            flex-direction: column;
        }

        .program-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: #e9d5ff;
        }

        .program-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }

        .program-btn {
            padding: 15px 10px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s;
        }

        .program-btn.active {
            background: #8b5cf6;
            color: white;
            border-color: transparent;
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4);
            transform: scale(1.05);
        }

        /* Manual Controls - BIGGER */
        .manual-controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 20px;
        }

        .control-title {
            font-size: 1.2em;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            margin-bottom: 15px;
        }

        .power-display {
            text-align: center;
            margin-bottom: 25px;
        }

        .power-value {
            font-size: 6em;
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(to bottom, #fff, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(167, 139, 250, 0.3));
        }

        .power-unit {
            font-size: 1.5em;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 600;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
        }

        .btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            font-size: 3em;
            border: none;
            cursor: pointer;
            background: linear-gradient(145deg, #8b5cf6, #7c3aed);
            color: white;
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.4);
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn:active {
            transform: scale(0.9);
        }

        .step-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .step-btn {
            padding: 12px 20px;
            font-size: 1.1em;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
        }

        .step-btn.active {
            background: #8b5cf6;
            border-color: transparent;
        }

        /* Program Info & Histogram */
        .program-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .difficulty-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }

        .difficulty-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.8em;
            background: #8b5cf6;
            color: white;
            border: none;
            cursor: pointer;
        }

        .difficulty-display {
            text-align: center;
            min-width: 120px;
        }

        .difficulty-label {
            font-size: 0.9em;
            opacity: 0.6;
        }

        .difficulty-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #a78bfa;
        }

        .current-power-display {
            text-align: center;
            margin-bottom: 20px;
            background: rgba(139, 92, 246, 0.1);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .current-power-value {
            font-size: 3em;
            font-weight: 800;
            color: white;
        }

        .current-power-unit {
            font-size: 1.2em;
            opacity: 0.7;
            margin-left: 5px;
        }

        .histogram-container {
            flex: 1;
            display: flex;
            gap: 10px;
            min-height: 150px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 16px;
            padding: 15px;
        }

        .histogram-scale {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 0.8em;
            opacity: 0.5;
            padding-right: 5px;
        }

        .program-histogram {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            position: relative;
        }

        .program-histogram::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .histogram-bar {
            flex: 1;
            background: rgba(139, 92, 246, 0.3);
            border-radius: 4px 4px 0 0;
            transition: height 0.3s;
        }

        .histogram-bar.completed {
            background: #10b981;
            opacity: 0.6;
        }

        .histogram-bar.current {
            background: #f59e0b;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
            z-index: 2;
        }

        /* Top Bar */
        .top-bar-item,
        .top-status-item,
        .fullscreen-btn,
        .system-btn,
        .programs-btn {
            background: rgba(30, 30, 40, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .top-bar-item {
            padding: 12px 20px;
            font-size: 1.1em;
        }

        .date-display {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        .time-display {
            position: fixed;
            top: 20px;
            left: 200px;
            z-index: 100;
            font-size: 1.2em;
            font-weight: 700;
        }

        .top-status-bar {
            position: fixed;
            top: 20px;
            right: 90px;
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .top-status-item {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            height: 50px;
        }

        .top-status-value {
            font-size: 1.2em;
            font-weight: 700;
            color: #a78bfa;
        }

        .status-connected {
            color: #10b981;
        }

        .status-disconnected {
            color: #ef4444;
        }

        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            background: #7c3aed;
        }

        .programs-btn {
            position: fixed;
            bottom: 20px;
            padding: 15px 25px;
            font-size: 1.1em;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .programs-btn:first-of-type {
            left: 50%;
            transform: translateX(-110%);
        }

        .programs-btn:last-of-type {
            left: 50%;
            transform: translateX(10%);
        }

        .system-btn {
            position: fixed;
            bottom: 20px;
            padding: 15px 25px;
            font-size: 1.1em;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shutdown-btn {
            left: 20px;
            background: rgba(220, 38, 38, 0.8);
        }

        .reboot-btn {
            right: 20px;
            background: rgba(234, 88, 12, 0.8);
        }

        /* Target RPM Control */
        .target-rpm-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 16px;
        }

        .target-rpm-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1em;
            font-weight: 600;
        }

        .target-rpm-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .target-rpm-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .target-rpm-value {
            color: #a78bfa;
            font-weight: 800;
            font-size: 2em;
            min-width: 80px;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }

        /* Mobile / Portrait adjustments */
        @media (max-width: 1024px) and (orientation: portrait) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .container {
                height: auto;
                min-height: 100vh;
            }
        }
    </style>
</head>

<body>
    <div class="date-display top-bar-item">
        <div class="datetime-day" id="datetimeDay">Lundi</div>
        <div class="datetime-date" id="datetimeDate">26 janvier 2025</div>
    </div>
    <div class="time-display top-bar-item" id="datetimeTime">14:30:00</div>

    <!-- Barre d'infos de statut en haut √† droite -->
    <div class="top-status-bar">
        <div class="top-status-item">
            <span class="top-status-value status-disconnected" id="connection-status-top">D√©connect√©</span>
        </div>
        <div class="top-status-item">
            <span class="top-status-label">RPM:</span>
            <span class="top-status-value" id="rpm-top">--</span>
        </div>
        <div class="top-status-item">
            <span class="top-status-label">Puissance:</span>
            <span class="top-status-value" id="power-top">-- W</span>
        </div>
    </div>

    <a href="/programs.html" class="programs-btn" title="Programmes d'entra√Ænement personnalis√©s">
        <span>üìã</span>
        <span>Programmes</span>
    </a>
    <button class="programs-btn" onclick="openProgramsEditor()" title="√âditer les programmes pr√©d√©finis">
        <span>‚öôÔ∏è</span>
        <span>√âditer</span>
    </button>
    <button class="fullscreen-btn" id="fullscreenBtn" onclick="toggleFullscreen()" title="Mode plein √©cran">‚õ∂</button>

    <!-- Boutons syst√®me -->
    <button class="system-btn shutdown-btn" onclick="confirmShutdown()" title="Arr√™ter le Raspberry Pi">
        <span>üî¥</span>
        <span>√âteindre</span>
    </button>
    <button class="system-btn reboot-btn" onclick="confirmReboot()" title="Red√©marrer le Raspberry Pi">
        <span>üîÑ</span>
        <span>Red√©marrer</span>
    </button>
    <div class="container">
        <div class="main-grid">
            <div class="left-column">
                <div class="rpm-chart-panel">
                    <div class="rpm-chart-title">üìä √âvolution du RPM</div>
                    <div class="target-rpm-control">
                        <span class="target-rpm-label">RPM Cible:</span>
                        <button onclick="decreaseTargetRpm()" class="target-rpm-btn">‚àí</button>
                        <span id="targetRpmDisplay" class="target-rpm-value">60</span>
                        <button onclick="increaseTargetRpm()" class="target-rpm-btn">+</button>
                    </div>
                    <div class="rpm-chart-container">
                        <canvas id="rpmChart"></canvas>
                    </div>
                </div>

                <div class="timer-panel">
                    <div class="timer-display" id="timer">00:00:00</div>
                    <div class="timer-controls">
                        <button class="timer-btn" id="startStopBtn" onclick="toggleTimer()">‚ñ∂ D√©marrer</button>
                        <button class="timer-btn" onclick="resetTimer()">‚Üª Reset</button>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="program-panel">
                    <div class="program-title">üìã Programme d'Entra√Ænement (30 min)</div>
                    <div class="program-selector">
                        <button class="program-btn active" onclick="selectProgram('none')">Manuel</button>
                        <button class="program-btn" onclick="selectProgram('plat')">Plat</button>
                        <button class="program-btn" onclick="selectProgram('vallee')">Vall√©e</button>
                        <button class="program-btn" onclick="selectProgram('collines')">Collines</button>
                        <button class="program-btn" onclick="selectProgram('montagne')">Montagne</button>
                        <button class="program-btn" onclick="selectProgram('alpin')">Col Alpin</button>
                        <button class="program-btn" onclick="selectProgram('intervalle')">Intervalle</button>
                        <button class="program-btn" onclick="selectProgram('pyramide')">Pyramide</button>
                        <button class="program-btn" onclick="selectProgram('changement')">Changement</button>
                        <button class="program-btn" onclick="selectProgram('altitude')">Altitude</button>
                    </div>

                    <!-- Contr√¥les pour mode Manuel -->
                    <div class="manual-controls" id="manualControls">
                        <div class="control-title">Contr√¥le de Puissance</div>
                        <div class="power-display">
                            <div class="power-value" id="powerControl">--</div>
                            <div class="power-unit">Watts</div>
                        </div>
                        <div class="button-container">
                            <button class="btn" id="decreaseBtn" onclick="decreasePower()">‚àí</button>
                            <button class="btn" id="increaseBtn" onclick="increasePower()">+</button>
                        </div>
                        <div class="step-controls">
                            <button class="step-btn" onclick="decreasePowerBy25()">-25W</button>
                            <button class="step-btn" onclick="decreasePowerBy10()">-10W</button>
                            <button class="step-btn active" onclick="setStep(5)">+5W</button>
                            <button class="step-btn" onclick="setStep(10)">+10W</button>
                            <button class="step-btn" onclick="setStep(25)">+25W</button>
                        </div>
                    </div>

                    <!-- Infos pour programmes automatiques -->
                    <div class="program-info" id="programInfo" style="display: none;">
                        <div class="difficulty-control">
                            <button class="difficulty-btn" onclick="decreaseDifficulty()">‚àí</button>
                            <div class="difficulty-display">
                                <div class="difficulty-label">Difficult√©</div>
                                <div class="difficulty-value" id="difficultyLevel">Normal</div>
                            </div>
                            <button class="difficulty-btn" onclick="increaseDifficulty()">+</button>
                        </div>
                        <div class="current-power-display">
                            <div class="current-power-label">Puissance Active</div>
                            <div>
                                <span class="current-power-value" id="currentActivePower">--</span>
                                <span class="current-power-unit">W</span>
                            </div>
                        </div>
                        <div class="histogram-container">
                            <div class="histogram-scale" id="histogramScale">
                                <div>200</div>
                                <div>150</div>
                                <div>100</div>
                                <div>50</div>
                                <div>0</div>
                            </div>
                            <div class="program-histogram" id="histogram"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal d'√©dition des programmes -->
    <div id="programsEditorModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; overflow-y: auto;">
        <div
            style="max-width: 1000px; margin: 40px auto; background: rgba(15, 15, 30, 0.98); border-radius: 20px; padding: 30px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h2 style="color: white; font-size: 1.8em; margin: 0;">‚öôÔ∏è √âdition des Programmes Pr√©d√©finis</h2>
                <button onclick="closeProgramsEditor()"
                    style="background: transparent; border: none; color: rgba(255,255,255,0.6); font-size: 2em; cursor: pointer; width: 40px; height: 40px;">&times;</button>
            </div>

            <div
                style="background: rgba(255,215,0,0.1); border: 1px solid rgba(255,215,0,0.3); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <p style="color: rgba(255,215,0,0.9); margin: 0; font-size: 0.9em;">
                    üí° <strong>Info:</strong> Modifiez les 30 valeurs de puissance (une par minute) pour chaque
                    programme. Les modifications sont sauvegard√©es dans votre navigateur.
                </p>
            </div>

            <div style="margin-bottom: 20px; text-align: right;">
                <button onclick="resetAllPrograms()"
                    style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    üîÑ R√©initialiser tous les programmes
                </button>
            </div>

            <div id="programsEditorList"></div>
        </div>
    </div>

    <script>
        let currentPower = 25;
        let powerStep = 5;
        let timerSeconds = 0;
        let timerInterval = null;
        let isTimerRunning = false;
        let rpmAutoStarted = false;

        // Variables pour le graphique RPM
        let rpmHistory = [];
        const MAX_RPM_HISTORY = 60; // 60 secondes d'historique
        let rpmChart = null;
        let rpmChartCtx = null;
        let targetRpm = 60; // RPM de r√©f√©rence par d√©faut

        // Variables pour les statistiques du programme
        let programStats = {
            active: false,
            startTime: null,
            rpmSamples: [],
            rpmAboveTarget: 0,
            rpmBelowTarget: 0,
            totalSamples: 0
        };

        // Charger le RPM cible depuis localStorage
        function loadTargetRpm() {
            const saved = localStorage.getItem('targetRpm');
            if (saved) {
                targetRpm = parseInt(saved);
                document.getElementById('targetRpmDisplay').textContent = targetRpm;
            }
        }

        // Sauvegarder le RPM cible dans localStorage
        function saveTargetRpm() {
            localStorage.setItem('targetRpm', targetRpm);
        }

        // Augmenter le RPM cible
        function increaseTargetRpm() {
            targetRpm += 5;
            if (targetRpm > 200) targetRpm = 200; // Maximum 200 RPM
            document.getElementById('targetRpmDisplay').textContent = targetRpm;
            saveTargetRpm();
            drawRpmChart();
        }

        // Diminuer le RPM cible
        function decreaseTargetRpm() {
            targetRpm -= 5;
            if (targetRpm < 20) targetRpm = 20; // Minimum 20 RPM
            document.getElementById('targetRpmDisplay').textContent = targetRpm;
            saveTargetRpm();
            drawRpmChart();
        }

        // D√©marrer la collecte de statistiques
        function startProgramStats() {
            programStats = {
                active: true,
                startTime: Date.now(),
                rpmSamples: [],
                rpmAboveTarget: 0,
                rpmBelowTarget: 0,
                totalSamples: 0
            };
        }

        // Arr√™ter la collecte et afficher la synth√®se
        function stopProgramStats() {
            if (!programStats.active) return;
            programStats.active = false;
            showProgramSummary();
        }

        // Enregistrer un √©chantillon RPM
        function recordRpmSample(rpm) {
            if (!programStats.active || !programActive) return;

            programStats.rpmSamples.push(rpm);
            programStats.totalSamples++;

            if (rpm >= targetRpm) {
                programStats.rpmAboveTarget++;
            } else {
                programStats.rpmBelowTarget++;
            }
        }

        // Afficher la synth√®se du programme
        function showProgramSummary() {
            if (programStats.totalSamples === 0) return;

            // Calculer les statistiques
            const avgRpm = programStats.rpmSamples.reduce((a, b) => a + b, 0) / programStats.totalSamples;
            const percentAbove = (programStats.rpmAboveTarget / programStats.totalSamples) * 100;
            const percentBelow = (programStats.rpmBelowTarget / programStats.totalSamples) * 100;
            const duration = Math.floor((Date.now() - programStats.startTime) / 1000);
            const durationMin = Math.floor(duration / 60);
            const durationSec = duration % 60;

            // Cr√©er la modal
            const modal = document.createElement('div');
            modal.id = 'summaryModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                backdrop-filter: blur(10px);
            `;

            modal.innerHTML = `
                <div style="
                    background: rgba(255, 255, 255, 0.05);
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 24px;
                    padding: 40px;
                    max-width: 600px;
                    width: 90%;
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                ">
                    <h2 style="
                        color: #a78bfa;
                        text-align: center;
                        margin-bottom: 30px;
                        font-size: 2em;
                        font-weight: 800;
                    ">üéâ Programme Termin√© !</h2>

                    <div style="
                        background: rgba(255, 255, 255, 0.03);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                        border-radius: 16px;
                        padding: 25px;
                        margin-bottom: 25px;
                    ">
                        <h3 style="color: rgba(255, 255, 255, 0.9); margin-bottom: 20px; font-size: 1.3em;">üìä Statistiques</h3>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="text-align: center; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85em; margin-bottom: 5px;">RPM Moyen</div>
                                <div style="color: #a78bfa; font-size: 2em; font-weight: 700;">${Math.round(avgRpm)}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.85em; margin-bottom: 5px;">Dur√©e</div>
                                <div style="color: #a78bfa; font-size: 2em; font-weight: 700;">${durationMin}m ${durationSec}s</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: rgba(255, 255, 255, 0.7);">Seuil: ${targetRpm} RPM</span>
                            </div>

                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span style="color: #22c55e; font-weight: 600;">‚úì Au-dessus</span>
                                    <span style="color: #22c55e; font-weight: 700;">${percentAbove.toFixed(1)}%</span>
                                </div>
                                <div style="height: 30px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; overflow: hidden; display: flex;">
                                    <div style="
                                        width: ${percentAbove}%;
                                        background: linear-gradient(90deg, #22c55e, #10b981);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-weight: 600;
                                        font-size: 0.85em;
                                    ">${percentAbove > 10 ? Math.round(percentAbove) + '%' : ''}</div>
                                    <div style="
                                        width: ${percentBelow}%;
                                        background: linear-gradient(90deg, #ef4444, #dc2626);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-weight: 600;
                                        font-size: 0.85em;
                                    ">${percentBelow > 10 ? Math.round(percentBelow) + '%' : ''}</div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                    <span style="color: #ef4444; font-weight: 600;">‚úó En dessous</span>
                                    <span style="color: #ef4444; font-weight: 700;">${percentBelow.toFixed(1)}%</span>
                                </div>
                            </div>
                        </div>

                        <canvas id="summaryChart" style="width: 100%; height: 150px; margin-top: 20px;"></canvas>
                    </div>

                    <button onclick="closeSummary()" style="
                        width: 100%;
                        padding: 15px;
                        background: linear-gradient(135deg, #a78bfa, #8b5cf6);
                        border: none;
                        border-radius: 12px;
                        color: white;
                        font-size: 1.1em;
                        font-weight: 700;
                        cursor: pointer;
                        transition: all 0.3s;
                        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
                    " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                        Fermer
                    </button>
                </div>
            `;

            document.body.appendChild(modal);

            // Dessiner le graphique de distribution RPM
            setTimeout(() => drawSummaryChart(programStats.rpmSamples), 100);
        }

        // Dessiner le graphique de distribution dans la synth√®se
        function drawSummaryChart(rpmSamples) {
            const canvas = document.getElementById('summaryChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            canvas.width = width;
            canvas.height = height;

            // Cr√©er un histogramme de distribution
            const bins = 10;
            const maxRpm = Math.max(...rpmSamples);
            const minRpm = Math.min(...rpmSamples);
            const binSize = (maxRpm - minRpm) / bins;
            const distribution = new Array(bins).fill(0);

            rpmSamples.forEach(rpm => {
                const binIndex = Math.min(Math.floor((rpm - minRpm) / binSize), bins - 1);
                distribution[binIndex]++;
            });

            const maxCount = Math.max(...distribution);
            const barWidth = width / bins;
            const padding = 10;

            // Dessiner les barres
            distribution.forEach((count, i) => {
                const barHeight = (count / maxCount) * (height - padding * 2);
                const x = i * barWidth;
                const y = height - padding - barHeight;
                const binRpm = minRpm + (i + 0.5) * binSize;
                const color = binRpm >= targetRpm ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)';

                ctx.fillStyle = color;
                ctx.fillRect(x + 2, y, barWidth - 4, barHeight);

                // Bordure
                ctx.strokeStyle = binRpm >= targetRpm ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x + 2, y, barWidth - 4, barHeight);
            });

            // Ligne de seuil
            const targetX = ((targetRpm - minRpm) / (maxRpm - minRpm)) * width;
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.8)';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(targetX, 0);
            ctx.lineTo(targetX, height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // Fermer la modal de synth√®se
        function closeSummary() {
            const modal = document.getElementById('summaryModal');
            if (modal) {
                modal.remove();
            }
        }

        // Variables des programmes d'entra√Ænement
        let currentProgram = 'none';
        let programActive = false;
        let difficultyAdjustment = 0;

        // D√©finition des programmes par d√©faut (30 minutes, puissance par minute)
        const defaultPrograms = {
            'plat': [
                25, 25, 25, 35, 35, 35, 35, 35, 35, 35,
                50, 50, 50, 50, 50, 50, 50, 50, 50, 50,
                35, 35, 35, 35, 35, 35, 25, 25, 25, 25
            ],
            'vallee': [
                25, 25, 25, 70, 90, 110, 120, 130, 120, 110,
                80, 70, 90, 110, 130, 140, 130, 110, 90, 100,
                120, 110, 100, 90, 80, 70, 60, 25, 25, 25
            ],
            'collines': [
                25, 25, 25, 50, 70, 90, 110, 130, 120, 100,
                80, 60, 40, 30, 50, 70, 90, 110, 130, 120,
                100, 80, 60, 55, 50, 45, 40, 25, 25, 25
            ],
            'montagne': [
                25, 25, 25, 80, 120, 140, 160, 150, 130, 110,
                90, 80, 100, 120, 140, 160, 180, 160, 140, 120,
                100, 90, 80, 70, 60, 60, 60, 25, 25, 25
            ],
            'alpin': [
                25, 25, 25, 50, 60, 70, 80, 90, 100, 110,
                120, 130, 140, 150, 160, 160, 150, 130, 110, 90,
                70, 60, 50, 45, 40, 35, 30, 25, 25, 25
            ],
            'intervalle': [
                25, 25, 25, 80, 50, 80, 50, 90, 50, 110,
                50, 110, 60, 125, 60, 125, 50, 110, 50, 90,
                50, 100, 50, 90, 50, 70, 50, 25, 25, 25
            ],
            'pyramide': [
                25, 25, 25, 40, 50, 60, 70, 80, 90, 100,
                110, 115, 120, 120, 120, 115, 110, 100, 90, 80,
                70, 60, 50, 40, 30, 25, 25, 25, 25, 25
            ],
            'changement': [
                25, 25, 25, 60, 50, 70, 100, 80, 60, 90,
                70, 60, 80, 100, 90, 70, 80, 100, 110, 90,
                70, 80, 90, 70, 60, 70, 80, 25, 25, 25
            ],
            'altitude': [
                25, 25, 25, 90, 80, 100, 120, 90, 70, 100,
                130, 110, 90, 120, 140, 120, 100, 140, 120, 100,
                80, 90, 110, 100, 80, 60, 50, 25, 25, 25
            ]
        };

        // Noms des programmes pour l'affichage
        const programNames = {
            'plat': 'Plat',
            'vallee': 'Vall√©e',
            'collines': 'Collines',
            'montagne': 'Montagne',
            'alpin': 'Col Alpin',
            'intervalle': 'Intervalle',
            'pyramide': 'Pyramide',
            'changement': 'Changement',
            'altitude': 'Altitude'
        };

        // Charger les programmes depuis localStorage ou utiliser les valeurs par d√©faut
        let programs = {};
        function loadPrograms() {
            const saved = localStorage.getItem('customPrograms');
            if (saved) {
                try {
                    programs = JSON.parse(saved);
                    console.log('‚úÖ Programmes personnalis√©s charg√©s depuis localStorage');
                } catch (e) {
                    console.error('‚ùå Erreur lors du chargement des programmes:', e);
                    programs = JSON.parse(JSON.stringify(defaultPrograms));
                }
            } else {
                programs = JSON.parse(JSON.stringify(defaultPrograms));
            }
        }

        // Sauvegarder les programmes dans localStorage
        function savePrograms() {
            localStorage.setItem('customPrograms', JSON.stringify(programs));
            console.log('üíæ Programmes sauvegard√©s');
        }

        // R√©initialiser tous les programmes aux valeurs par d√©faut
        function resetAllPrograms() {
            if (confirm('‚ö†Ô∏è Voulez-vous vraiment r√©initialiser TOUS les programmes √† leurs valeurs par d√©faut ?\n\nCette action est irr√©versible.')) {
                programs = JSON.parse(JSON.stringify(defaultPrograms));
                savePrograms();
                alert('‚úÖ Tous les programmes ont √©t√© r√©initialis√©s !');
                closeProgramsEditor();
                // Recharger l'affichage si un programme est actif
                if (currentProgram !== 'none') {
                    selectProgram(currentProgram);
                }
            }
        }

        // Charger les programmes au d√©marrage
        loadPrograms();

        // Formater le temps en HH:MM:SS
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Mettre √† jour l'affichage du chronom√®tre
        function updateTimerDisplay() {
            document.getElementById('timer').textContent = formatTime(timerSeconds);
        }

        // D√©marrer/Arr√™ter le chronom√®tre
        function toggleTimer() {
            const btn = document.getElementById('startStopBtn');
            if (!btn) {
                console.error('‚ùå Bouton startStopBtn introuvable');
                return;
            }

            if (isTimerRunning) {
                // Arr√™ter le chronom√®tre
                console.log('‚è∏Ô∏è Pause du chronom√®tre');
                clearInterval(timerInterval);
                timerInterval = null;
                isTimerRunning = false;
                btn.textContent = '‚ñ∂ D√©marrer';
                btn.classList.remove('running');
            } else {
                // D√©marrer le chronom√®tre
                console.log('‚ñ∂Ô∏è D√©marrage du chronom√®tre');
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                    updateProgramProgress();

                    // V√©rifier si le programme est termin√© (30 minutes = 1800 secondes)
                    if (programActive && timerSeconds >= 1800) {
                        console.log('üèÅ Programme termin√© (30 min)');
                        clearInterval(timerInterval);
                        timerInterval = null;
                        isTimerRunning = false;
                        btn.textContent = '‚ñ∂ D√©marrer';
                        btn.classList.remove('running');
                        stopProgramStats(); // Afficher la synth√®se
                    }
                }, 1000);
                isTimerRunning = true;
                btn.textContent = '‚è∏ Arr√™ter';
                btn.classList.add('running');
            }
        }

        // R√©initialiser le chronom√®tre
        function resetTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
            timerSeconds = 0;
            isTimerRunning = false;
            rpmAutoStarted = false;
            updateTimerDisplay();
            const btn = document.getElementById('startStopBtn');
            btn.textContent = '‚ñ∂ D√©marrer';
            btn.classList.remove('running');

            // R√©initialiser le programme et la difficult√© si un programme est actif
            if (programActive) {
                difficultyAdjustment = 0;
                updateDifficultyDisplay();
                renderHistogram();
            }

            // R√©initialiser la progression du programme
            updateProgramProgress();
        }

        // Mettre √† jour l'affichage de la puissance active
        function updateActivePowerDisplay() {
            if (!programActive || !programs[currentProgram]) {
                document.getElementById('currentActivePower').textContent = '--';
                return;
            }

            const currentMinute = Math.floor(timerSeconds / 60);
            if (currentMinute < 30) {
                const basePower = programs[currentProgram][currentMinute];
                const adjustedPower = Math.max(0, basePower + difficultyAdjustment);
                document.getElementById('currentActivePower').textContent = adjustedPower;
            } else {
                document.getElementById('currentActivePower').textContent = '0';
            }
        }

        // Augmenter la difficult√©
        function increaseDifficulty() {
            if (!programActive) return;

            difficultyAdjustment = Math.min(difficultyAdjustment + 5, 100);
            updateDifficultyDisplay();
            renderHistogram();
            updateActivePowerDisplay();

            // Appliquer imm√©diatement le changement de difficult√© si le timer est en cours
            if (isTimerRunning && programs[currentProgram]) {
                const currentMinute = Math.floor(timerSeconds / 60);
                if (currentMinute < 30) {
                    const basePower = programs[currentProgram][currentMinute];
                    const adjustedPower = Math.max(25, basePower + difficultyAdjustment);
                    setPower(adjustedPower);
                }
            }
        }

        // Diminuer la difficult√©
        function decreaseDifficulty() {
            if (!programActive) return;

            difficultyAdjustment = Math.max(difficultyAdjustment - 5, -100);
            updateDifficultyDisplay();
            renderHistogram();
            updateActivePowerDisplay();

            // Appliquer imm√©diatement le changement de difficult√© si le timer est en cours
            if (isTimerRunning && programs[currentProgram]) {
                const currentMinute = Math.floor(timerSeconds / 60);
                if (currentMinute < 30) {
                    const basePower = programs[currentProgram][currentMinute];
                    const adjustedPower = Math.max(25, basePower + difficultyAdjustment);
                    setPower(adjustedPower);
                }
            }
        }

        // Mettre √† jour l'affichage de la difficult√©
        function updateDifficultyDisplay() {
            const display = document.getElementById('difficultyLevel');

            if (difficultyAdjustment > 0) {
                display.textContent = `+${difficultyAdjustment}W`;
                display.style.color = '#f44336';
            } else if (difficultyAdjustment < 0) {
                display.textContent = `${difficultyAdjustment}W`;
                display.style.color = '#28a745';
            } else {
                display.textContent = 'Normal';
                display.style.color = '#a78bfa';
            }
        }

        // S√©lectionner un programme
        function selectProgram(program) {
            currentProgram = program;
            programActive = (program !== 'none');

            // Mettre √† jour les boutons
            document.querySelectorAll('.program-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Afficher/masquer les contr√¥les appropri√©s
            const programInfo = document.getElementById('programInfo');
            const manualControls = document.getElementById('manualControls');

            if (programActive) {
                // Mode programme automatique
                programInfo.style.display = 'block';
                manualControls.style.display = 'none';
                difficultyAdjustment = 0;
                updateDifficultyDisplay();
                renderHistogram();
                resetTimer();
                startProgramStats(); // D√©marrer la collecte de statistiques

                // D√©finir la puissance initiale du programme (minute 0)
                if (programs[currentProgram]) {
                    const initialPower = Math.max(25, programs[currentProgram][0] + difficultyAdjustment);
                    setPower(initialPower);
                    updateActivePowerDisplay();
                }
            } else {
                // Mode manuel
                programInfo.style.display = 'none';
                manualControls.style.display = 'block';
                // D√©finir la puissance par d√©faut en mode manuel √† 25W
                setPower(25);
            }
        }

        // G√©n√©rer l'histogramme du programme
        function renderHistogram() {
            if (!programActive || !programs[currentProgram]) return;

            const histogram = document.getElementById('histogram');
            histogram.innerHTML = '';

            const powerValues = programs[currentProgram];

            // Calculer le max avec l'ajustement de difficult√©
            const maxAdjusted = Math.max(...powerValues.map(p => Math.max(0, p + difficultyAdjustment)));

            // Cr√©er une barre pour chaque minute
            powerValues.forEach((power, index) => {
                const adjustedPower = Math.max(0, power + difficultyAdjustment);

                const bar = document.createElement('div');
                bar.className = 'histogram-bar';
                bar.style.height = `${(adjustedPower / maxAdjusted) * 100}%`;

                // Colorer la barre en fonction de la progression
                const currentMinute = Math.floor(timerSeconds / 60);
                if (index < currentMinute) {
                    bar.classList.add('completed');
                } else if (index === currentMinute) {
                    bar.classList.add('current');
                }

                bar.title = `Minute ${index + 1}: ${adjustedPower}W`;

                histogram.appendChild(bar);
            });

            // Mettre √† jour l'√©chelle
            const scale = document.getElementById('histogramScale');
            const step = Math.ceil(maxAdjusted / 4 / 10) * 10;
            scale.innerHTML = '';
            for (let i = 4; i >= 0; i--) {
                const div = document.createElement('div');
                div.textContent = step * i;
                scale.appendChild(div);
            }
        }

        // Mettre √† jour la progression du programme
        function updateProgramProgress() {
            if (!programActive || currentProgram === 'none') return;

            const currentMinute = Math.floor(timerSeconds / 60);

            // Mettre √† jour l'affichage de la puissance active
            updateActivePowerDisplay();

            // Mettre √† jour les couleurs de l'histogramme
            const bars = document.querySelectorAll('.histogram-bar');
            bars.forEach((bar, index) => {
                bar.classList.remove('completed', 'current');
                if (index < currentMinute) {
                    bar.classList.add('completed');
                } else if (index === currentMinute) {
                    bar.classList.add('current');
                }
            });

            // Obtenir la puissance cible pour la minute actuelle
            if (programs[currentProgram] && currentMinute < 30) {
                const basePower = programs[currentProgram][currentMinute];
                const adjustedPower = Math.max(25, basePower + difficultyAdjustment);

                // Ajuster automatiquement la puissance si le programme est actif et le chrono tourne
                if (isTimerRunning && currentMinute >= 0) {
                    setPower(adjustedPower);
                }
            }
        }

        // D√©finir la puissance
        async function setPower(watts) {
            try {
                console.log('üîß D√©finir puissance:', watts, 'W', 'currentPower avant:', currentPower);
                const response = await fetch(`/power/${watts}`, { method: 'POST' });
                console.log('üì° R√©ponse fetch:', response.status, response.statusText);

                if (response.ok) {
                    const responseText = await response.text();
                    console.log('üìù R√©ponse serveur:', responseText);
                    currentPower = watts;
                    updateDisplay();
                    console.log('‚úÖ Puissance d√©finie:', watts, 'W', 'currentPower apr√®s:', currentPower);
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erreur r√©ponse serveur:', response.status, errorText);
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du r√©glage de la puissance:', error);
            }
        }

        // Augmenter la puissance
        async function increasePower() {
            console.log('üîº BOUTON + CLIQU√â - currentPower:', currentPower, 'powerStep:', powerStep);
            const newPower = Math.min(currentPower + powerStep, 400);
            console.log('‚¨ÜÔ∏è Augmenter puissance:', currentPower, '‚Üí', newPower);
            await setPower(newPower);
        }

        // Diminuer la puissance
        async function decreasePower() {
            console.log('üîΩ BOUTON - CLIQU√â - currentPower:', currentPower, 'powerStep:', powerStep);
            const newPower = Math.max(currentPower - powerStep, 25);
            console.log('‚¨áÔ∏è Diminuer puissance:', currentPower, '‚Üí', newPower);
            await setPower(newPower);
        }

        // Changer le pas d'ajustement
        function setStep(step) {
            powerStep = step;
            document.querySelectorAll('.step-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // Diminuer la puissance de 10W directement
        async function decreasePowerBy10() {
            console.log('üîΩ BOUTON -10W - CLIQU√â - currentPower:', currentPower);
            const newPower = Math.max(currentPower - 10, 25);
            console.log('‚¨áÔ∏è Diminuer puissance de 10W:', currentPower, '‚Üí', newPower);
            await setPower(newPower);
        }

        // Diminuer la puissance de 25W directement
        async function decreasePowerBy25() {
            console.log('üîΩ BOUTON -25W - CLIQU√â - currentPower:', currentPower);
            const newPower = Math.max(currentPower - 25, 25);
            console.log('‚¨áÔ∏è Diminuer puissance de 25W:', currentPower, '‚Üí', newPower);
            await setPower(newPower);
        }

        // Mettre √† jour l'affichage
        function updateDisplay() {
            console.log('üîÑ updateDisplay appel√© - currentPower:', currentPower);

            const powerTop = document.getElementById('power-top');
            if (powerTop) {
                powerTop.textContent = currentPower + ' W';
                console.log('‚úì power-top mis √† jour:', powerTop.textContent);
            } else {
                console.warn('‚ö†Ô∏è power-top introuvable');
            }

            const powerControl = document.getElementById('powerControl');
            if (powerControl) {
                powerControl.textContent = currentPower;
                console.log('‚úì powerControl mis √† jour:', powerControl.textContent);
            } else {
                console.warn('‚ö†Ô∏è powerControl introuvable');
            }
        }

        // Initialiser le graphique RPM
        function initRpmChart() {
            try {
                rpmChart = document.getElementById('rpmChart');
                if (!rpmChart) {
                    console.error('‚ùå Canvas RPM introuvable');
                    return;
                }

                const container = rpmChart.parentElement;
                if (!container) {
                    console.error('‚ùå Container du canvas RPM introuvable');
                    return;
                }

                // V√©rifier que le container a des dimensions
                if (container.clientWidth === 0 || container.clientHeight === 0) {
                    console.warn('‚ö†Ô∏è Container sans dimensions, nouvelle tentative dans 200ms');
                    setTimeout(initRpmChart, 200);
                    return;
                }

                rpmChartCtx = rpmChart.getContext('2d');
                if (!rpmChartCtx) {
                    console.error('‚ùå Impossible d\'obtenir le contexte 2D du canvas');
                    return;
                }

                // D√©finir la taille du canvas
                rpmChart.width = container.clientWidth;
                rpmChart.height = container.clientHeight;

                // Initialiser l'historique avec des z√©ros
                rpmHistory = Array(MAX_RPM_HISTORY).fill(0);

                drawRpmChart();
                console.log('‚úÖ Graphique RPM initialis√©:', rpmChart.width, 'x', rpmChart.height);
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation du graphique RPM:', error);
            }
        }

        // Dessiner le graphique RPM
        function drawRpmChart() {
            if (!rpmChartCtx || !rpmChart) return;

            const width = rpmChart.width;
            const height = rpmChart.height;
            const padding = 40;
            const chartWidth = width - padding * 2;
            const chartHeight = height - padding * 2;

            // Effacer le canvas
            rpmChartCtx.clearRect(0, 0, width, height);

            // Trouver le maximum pour l'√©chelle (inclure targetRpm)
            const maxRpm = Math.max(...rpmHistory, targetRpm, 100); // Minimum 100 pour l'√©chelle
            const roundedMax = Math.ceil(maxRpm / 20) * 20; // Arrondir au 20 sup√©rieur

            // Dessiner le fond de la grille
            rpmChartCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            rpmChartCtx.lineWidth = 1;

            // Lignes horizontales de la grille
            for (let i = 0; i <= 4; i++) {
                const y = padding + (chartHeight * i) / 4;
                rpmChartCtx.beginPath();
                rpmChartCtx.moveTo(padding, y);
                rpmChartCtx.lineTo(width - padding, y);
                rpmChartCtx.stroke();

                // √âtiquettes de l'axe Y
                const value = roundedMax - (roundedMax * i) / 4;
                rpmChartCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                rpmChartCtx.font = '11px Inter';
                rpmChartCtx.textAlign = 'right';
                rpmChartCtx.fillText(Math.round(value), padding - 10, y + 4);
            }

            // Dessiner la ligne de seuil RPM cible
            const targetY = height - padding - (targetRpm / roundedMax) * chartHeight;
            rpmChartCtx.strokeStyle = 'rgba(255, 215, 0, 0.6)';
            rpmChartCtx.lineWidth = 2;
            rpmChartCtx.setLineDash([5, 5]);
            rpmChartCtx.beginPath();
            rpmChartCtx.moveTo(padding, targetY);
            rpmChartCtx.lineTo(width - padding, targetY);
            rpmChartCtx.stroke();
            rpmChartCtx.setLineDash([]);

            // Label pour le seuil
            rpmChartCtx.fillStyle = 'rgba(255, 215, 0, 0.9)';
            rpmChartCtx.font = 'bold 11px Inter';
            rpmChartCtx.textAlign = 'left';
            rpmChartCtx.fillText(`Cible: ${targetRpm}`, padding + 5, targetY - 5);

            // Dessiner la courbe RPM avec coloration conditionnelle
            if (rpmHistory.length > 0) {
                const pointSpacing = chartWidth / (MAX_RPM_HISTORY - 1);

                // Dessiner l'aire sous la courbe avec gradient conditionnel
                for (let i = 0; i < rpmHistory.length - 1; i++) {
                    const x1 = padding + i * pointSpacing;
                    const y1 = height - padding - (rpmHistory[i] / roundedMax) * chartHeight;
                    const x2 = padding + (i + 1) * pointSpacing;
                    const y2 = height - padding - (rpmHistory[i + 1] / roundedMax) * chartHeight;

                    // D√©terminer la couleur en fonction du RPM moyen du segment
                    const avgRpm = (rpmHistory[i] + rpmHistory[i + 1]) / 2;
                    const color = avgRpm >= targetRpm
                        ? 'rgba(34, 197, 94, 0.15)'  // Vert si au-dessus
                        : 'rgba(239, 68, 68, 0.15)';  // Rouge si en dessous

                    rpmChartCtx.fillStyle = color;
                    rpmChartCtx.beginPath();
                    rpmChartCtx.moveTo(x1, y1);
                    rpmChartCtx.lineTo(x2, y2);
                    rpmChartCtx.lineTo(x2, height - padding);
                    rpmChartCtx.lineTo(x1, height - padding);
                    rpmChartCtx.closePath();
                    rpmChartCtx.fill();
                }

                // Dessiner la ligne avec segments color√©s
                rpmChartCtx.lineWidth = 2.5;
                for (let i = 0; i < rpmHistory.length - 1; i++) {
                    const x1 = padding + i * pointSpacing;
                    const y1 = height - padding - (rpmHistory[i] / roundedMax) * chartHeight;
                    const x2 = padding + (i + 1) * pointSpacing;
                    const y2 = height - padding - (rpmHistory[i + 1] / roundedMax) * chartHeight;

                    // D√©terminer la couleur en fonction du RPM moyen du segment
                    const avgRpm = (rpmHistory[i] + rpmHistory[i + 1]) / 2;
                    rpmChartCtx.strokeStyle = avgRpm >= targetRpm
                        ? 'rgba(34, 197, 94, 1)'  // Vert si au-dessus
                        : 'rgba(239, 68, 68, 1)';  // Rouge si en dessous

                    rpmChartCtx.beginPath();
                    rpmChartCtx.moveTo(x1, y1);
                    rpmChartCtx.lineTo(x2, y2);
                    rpmChartCtx.stroke();
                }

                // Dessiner un point au dernier point de donn√©es
                const lastX = padding + (rpmHistory.length - 1) * pointSpacing;
                const lastY = height - padding - (rpmHistory[rpmHistory.length - 1] / roundedMax) * chartHeight;
                const lastRpm = rpmHistory[rpmHistory.length - 1];
                const lastColor = lastRpm >= targetRpm ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)';

                rpmChartCtx.fillStyle = lastColor;
                rpmChartCtx.beginPath();
                rpmChartCtx.arc(lastX, lastY, 4, 0, Math.PI * 2);
                rpmChartCtx.fill();

                // Cercle ext√©rieur anim√©
                rpmChartCtx.strokeStyle = lastColor;
                rpmChartCtx.lineWidth = 2;
                rpmChartCtx.beginPath();
                rpmChartCtx.arc(lastX, lastY, 6, 0, Math.PI * 2);
                rpmChartCtx.stroke();
            }

            // √âtiquettes des axes
            rpmChartCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            rpmChartCtx.font = '10px Inter';
            rpmChartCtx.textAlign = 'center';
            rpmChartCtx.fillText('60s', padding + 5, height - 5);
            rpmChartCtx.fillText('0s', width - padding - 5, height - 5);
        }

        // Ajouter une valeur RPM √† l'historique
        function addRpmToHistory(rpm) {
            rpmHistory.push(rpm);
            if (rpmHistory.length > MAX_RPM_HISTORY) {
                rpmHistory.shift();
            }
            drawRpmChart();
        }

        // R√©cup√©rer le statut du v√©lo
        async function updateStatus() {
            try {
                const response = await fetch('/status');
                if (response.ok) {
                    const data = await response.json();

                    // Mise √† jour de l'√©tat de connexion dans la barre du haut
                    const connectionStatusTop = document.getElementById('connection-status-top');
                    if (connectionStatusTop) {
                        // Supprimer les anciennes classes
                        connectionStatusTop.classList.remove('status-connected', 'status-disconnected');

                        if (data.connected) {
                            connectionStatusTop.textContent = 'Connect√©';
                            connectionStatusTop.classList.add('status-connected');
                        } else {
                            connectionStatusTop.textContent = 'D√©connect√©';
                            connectionStatusTop.classList.add('status-disconnected');
                        }
                    }

                    // Mise √† jour du RPM dans la barre du haut
                    const rpmTop = document.getElementById('rpm-top');
                    if (rpmTop) {
                        rpmTop.textContent = data.rpm + ' tr/min';
                    }

                    // Mise √† jour de la puissance dans la barre du haut
                    const powerTop = document.getElementById('power-top');
                    if (powerTop) {
                        powerTop.textContent = data.power + ' W';
                    }

                    // Ne pas √©craser currentPower si on est en train de le modifier
                    // Seulement le mettre √† jour si la diff√©rence est significative (plus de 5W)
                    if (Math.abs(data.power - currentPower) > 5) {
                        console.log('üì° Mise √† jour currentPower depuis le serveur:', currentPower, '‚Üí', data.power);
                        currentPower = data.power;
                        updateDisplay();
                    }

                    // Ajouter le RPM √† l'historique du graphique
                    addRpmToHistory(data.rpm);

                    // Enregistrer le RPM pour les statistiques du programme
                    recordRpmSample(data.rpm);

                    // Auto-start/restart du chrono si RPM > 0
                    if (data.rpm > 0 && !isTimerRunning) {
                        console.log('üé¨ D√©marrage automatique du chrono (RPM:', data.rpm, ')');
                        toggleTimer();
                        rpmAutoStarted = true;
                    }

                    // Auto-pause si RPM = 0 apr√®s avoir d√©marr√©
                    if (data.rpm === 0 && rpmAutoStarted && isTimerRunning) {
                        console.log('‚è∏Ô∏è Pause automatique du chrono (RPM = 0)');
                        toggleTimer();
                    }
                } else {
                    console.error('‚ùå Erreur r√©ponse /status:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Erreur lors de la r√©cup√©ration du statut:', error);
            }
        }

        // Actualiser toutes les 500ms
        setInterval(updateStatus, 500);

        // Mode plein √©cran
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                // Entrer en mode plein √©cran
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Erreur lors du passage en plein √©cran: ${err.message}`);
                });
            } else {
                // Sortir du mode plein √©cran
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Mettre √† jour l'ic√¥ne du bouton en fonction de l'√©tat plein √©cran
        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreenBtn');
            if (document.fullscreenElement) {
                btn.textContent = '‚õ∂'; // Ic√¥ne "Quitter le plein √©cran"
                btn.title = 'Quitter le plein √©cran';
            } else {
                btn.textContent = '‚õ∂'; // Ic√¥ne "Plein √©cran"
                btn.title = 'Mode plein √©cran';
            }
        });

        // Fonctions de gestion syst√®me
        function confirmShutdown() {
            if (confirm('‚ö†Ô∏è Voulez-vous vraiment √âTEINDRE le Raspberry Pi ?\n\nLe syst√®me sera compl√®tement arr√™t√©.')) {
                fetch('/system/shutdown', {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        alert('üî¥ ' + data.message);
                    })
                    .catch(error => {
                        console.error('Erreur lors de l\'arr√™t:', error);
                        alert('‚ùå Erreur lors de l\'arr√™t du syst√®me');
                    });
            }
        }

        function confirmReboot() {
            if (confirm('‚ö†Ô∏è Voulez-vous vraiment RED√âMARRER le Raspberry Pi ?\n\nLe syst√®me red√©marrera automatiquement.')) {
                fetch('/system/reboot', {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        alert('üîÑ ' + data.message);
                    })
                    .catch(error => {
                        console.error('Erreur lors du red√©marrage:', error);
                        alert('‚ùå Erreur lors du red√©marrage du syst√®me');
                    });
            }
        }

        // Mettre √† jour la date et l'heure
        function updateDateTime() {
            const now = new Date();

            // Jours de la semaine en fran√ßais
            const jours = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
            const mois = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin',
                'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];

            // Jour de la semaine
            const jour = jours[now.getDay()];

            // Date format√©e
            const date = `${now.getDate()} ${mois[now.getMonth()]} ${now.getFullYear()}`;

            // Heure format√©e
            const heures = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const secondes = String(now.getSeconds()).padStart(2, '0');
            const heure = `${heures}:${minutes}:${secondes}`;

            // Mise √† jour de l'affichage
            document.getElementById('datetimeDay').textContent = jour;
            document.getElementById('datetimeDate').textContent = date;
            document.getElementById('datetimeTime').textContent = heure;
        }

        // Mettre √† jour la date/heure toutes les secondes
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Initialisation - Attendre que le DOM soit compl√®tement charg√©
        function initializeApp() {
            try {
                console.log('üöÄ Initialisation de l\'application...');

                // V√©rifier que les √©l√©ments critiques existent
                const manualControls = document.getElementById('manualControls');
                const increaseBtn = document.getElementById('increaseBtn');
                const decreaseBtn = document.getElementById('decreaseBtn');
                const powerControl = document.getElementById('powerControl');

                console.log('üîç √âl√©ments trouv√©s:');
                console.log('  - manualControls:', manualControls ? 'OK' : '‚ùå MANQUANT');
                console.log('  - increaseBtn:', increaseBtn ? 'OK' : '‚ùå MANQUANT');
                console.log('  - decreaseBtn:', decreaseBtn ? 'OK' : '‚ùå MANQUANT');
                console.log('  - powerControl:', powerControl ? 'OK' : '‚ùå MANQUANT');

                // Afficher les contr√¥les manuels par d√©faut
                if (manualControls) {
                    manualControls.style.display = 'block';
                    console.log('‚úì Contr√¥les manuels affich√©s');
                }

                updateTimerDisplay();
                updateDisplay();
                loadPrograms();
                loadTargetRpm();

                // Initialiser le graphique RPM avec un petit d√©lai pour s'assurer que le layout est pr√™t
                setTimeout(() => {
                    initRpmChart();
                }, 100);

                // D√©marrer la mise √† jour du statut
                updateStatus();

                // D√©finir la puissance par d√©faut √† 25W au d√©marrage (mode manuel)
                setPower(25);

                console.log('‚úÖ Application initialis√©e avec succ√®s');
                console.log('üìä Variables globales:');
                console.log('  - currentPower:', currentPower);
                console.log('  - powerStep:', powerStep);
                console.log('  - programActive:', programActive);
            } catch (error) {
                console.error('‚ùå Erreur lors de l\'initialisation:', error);
            }
        }

        // Lancer l'initialisation
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Redimensionner le graphique si la fen√™tre change de taille
        window.addEventListener('resize', () => {
            if (rpmChart && rpmChartCtx) {
                const container = rpmChart.parentElement;
                rpmChart.width = container.clientWidth;
                rpmChart.height = container.clientHeight;
                drawRpmChart();
            }
        });

        // ===== Fonctions d'√©dition des programmes =====

        // Ouvrir le modal d'√©dition des programmes
        function openProgramsEditor() {
            const modal = document.getElementById('programsEditorModal');
            const listContainer = document.getElementById('programsEditorList');
            listContainer.innerHTML = '';

            // Cr√©er une carte pour chaque programme
            Object.keys(programs).forEach(programId => {
                const card = document.createElement('div');
                card.style.cssText = 'background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 15px;';

                const header = document.createElement('div');
                header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;';
                header.innerHTML = `
                    <h3 style="color: white; margin: 0; font-size: 1.3em;">${programNames[programId]}</h3>
                    <div>
                        <button onclick="editProgramValues('${programId}')" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 10px;">‚úé √âditer</button>
                        <button onclick="resetSingleProgram('${programId}')" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;">üîÑ R√©initialiser</button>
                    </div>
                `;

                // Mini histogramme de pr√©visualisation
                const preview = document.createElement('div');
                preview.style.cssText = 'display: flex; gap: 2px; height: 60px; align-items: flex-end;';
                programs[programId].forEach(power => {
                    const bar = document.createElement('div');
                    const height = (power / 200) * 100; // Max 200W pour l'affichage
                    bar.style.cssText = `flex: 1; background: linear-gradient(180deg, #8b5cf6, #a78bfa); border-radius: 2px 2px 0 0; height: ${height}%; opacity: 0.7;`;
                    preview.appendChild(bar);
                });

                card.appendChild(header);
                card.appendChild(preview);
                listContainer.appendChild(card);
            });

            modal.style.display = 'block';
        }

        // Fermer le modal d'√©dition
        function closeProgramsEditor() {
            document.getElementById('programsEditorModal').style.display = 'none';
        }

        // √âditer les valeurs d'un programme
        function editProgramValues(programId) {
            const newValues = prompt(
                `‚úèÔ∏è √âditer le programme "${programNames[programId]}"\n\n` +
                `Entrez 30 valeurs s√©par√©es par des virgules (une par minute)\n` +
                `Plage : 25-400 Watts\n\n` +
                `Valeurs actuelles :\n${programs[programId].join(', ')}`,
                programs[programId].join(', ')
            );

            if (newValues !== null) {
                try {
                    const values = newValues.split(',').map(v => parseInt(v.trim()));

                    // Validation
                    if (values.length !== 30) {
                        alert('‚ùå Erreur : Vous devez entrer exactement 30 valeurs !');
                        return;
                    }

                    if (values.some(v => isNaN(v) || v < 25 || v > 400)) {
                        alert('‚ùå Erreur : Toutes les valeurs doivent √™tre des nombres entre 25 et 400 !');
                        return;
                    }

                    // Sauvegarder
                    programs[programId] = values;
                    savePrograms();
                    alert(`‚úÖ Programme "${programNames[programId]}" mis √† jour !`);

                    // Rafra√Æchir l'affichage
                    openProgramsEditor();

                    // Recharger si c'est le programme actif
                    if (currentProgram === programId) {
                        selectProgram(programId);
                    }
                } catch (e) {
                    alert('‚ùå Erreur de format. Utilisez des nombres s√©par√©s par des virgules.');
                }
            }
        }

        // R√©initialiser un seul programme
        function resetSingleProgram(programId) {
            if (confirm(`‚ö†Ô∏è R√©initialiser le programme "${programNames[programId]}" √† ses valeurs par d√©faut ?`)) {
                programs[programId] = [...defaultPrograms[programId]];
                savePrograms();
                alert(`‚úÖ Programme "${programNames[programId]}" r√©initialis√© !`);
                openProgramsEditor();

                // Recharger si c'est le programme actif
                if (currentProgram === programId) {
                    selectProgram(programId);
                }
            }
        }
    </script>
</body>

</html>